#!/usr/bin/env bash

# Ref from https://github.com/ThePrimeagen/.dotfiles/blob/master/bin/.local/scripts/tmux-sessionizer

if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$({
        sessions=$(tmux list-sessions -F '#{session_last_attached} #{session_name}' 2>/dev/null)
        bell_sessions=$(tmux list-windows -a -F '#{session_name} #{window_bell_flag}' 2>/dev/null | awk '$2 == "1" {print $1}' | sort -u)
        active_bell="" active="" inactive=""
        while IFS= read -r dir; do
            if [[ -d "$dir" ]]; then
                name=$(basename "$dir" | tr . _)
                ts=$(echo "$sessions" | awk -v n="$name" '$2 == n {print $1}')
                if [[ -n "$ts" ]]; then
                    if echo "$bell_sessions" | grep -qx "$name"; then
                        active_bell+="$ts $dir 󰂞"$'\n'
                    else
                        active+="$ts $dir ●"$'\n'
                    fi
                else
                    inactive+="$dir"$'\n'
                fi
            fi
        done < <(find -L ~/dev -mindepth 1 -maxdepth 1 -type d; echo ~/dotfiles; echo ~/.claude)
        echo "$active_bell" | sort -rn | cut -d' ' -f2-
        echo "$active" | sort -rn | cut -d' ' -f2-
        echo "$inactive"
    } | sed '/^$/d' | fzf --no-sort --tmux center,70%)
fi

if [[ -z $selected ]]; then
    exit 0
fi

selected="${selected% 󰂞}"
selected="${selected% ●}"
selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected
    exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds $selected_name -c $selected
fi

if [[ -z $TMUX ]]; then
    tmux attach-session -t $selected_name
else
    tmux switch-client -t $selected_name
fi
